<h1 id="stackmarks.sty----faking-stacked-diacritical-marks-with-challenged-fonts-in-xelatex"><em>stackmarks.sty</em> -- faking stacked diacritical marks with challenged fonts in XeLaTeX</h1>
<p>Benct Philip Jonsson <script type="text/javascript">
<!--
h='&#x67;&#x6d;&#x61;&#x69;&#108;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#98;&#112;&#106;&#x6f;&#110;&#x73;&#x73;&#x6f;&#110;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#98;&#112;&#106;&#x6f;&#110;&#x73;&#x73;&#x6f;&#110;&#32;&#x61;&#116;&#32;&#x67;&#x6d;&#x61;&#x69;&#108;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;</noscript></p>
<h2 id="contents">Contents</h2>
<ul>
<li>The problem
<ul>
<li>Todo (maybe)</li>
</ul></li>
<li>Dependencies</li>
<li>Installation</li>
<li>Basic usage</li>
<li>User macros for stacking diacritics
<ul>
<li><code>\stackMarks</code></li>
<li>bold, italic and bold italic</li>
</ul></li>
<li>Adjusting the 'raise' and kerning of marks
<ul>
<li><code>\stackMarksMarkBase</code></li>
<li>User macros for setting default arguments</li>
</ul></li>
</ul>
<p>Sometimes you have to use fonts with XeLaTeX which lack mark-to- mark anchors, and then have to fake stacked diacritics by moving around TeX boxes. This hack makes that somewhat easier.</p>
<p><strong>Note</strong> that currently it is not possible to nest <code>\stackMarks</code>* commands inside each other: since the LaTeX <code>length</code>s used internally will be set to values which are appropriate only for one of them. This may be adressed in the future by adding support for optional extra mark arguments.</p>
<h3 id="todo-maybe">Todo (maybe)</h3>
<p><em>stackmarks.sty</em> is currently limited to one diacritic above another, the lower mark being non-faked and marks above the letter.</p>
<p>I plan to possibly add macros for, so please <a href="https://github.com/bpj/stackmarks-xelatex/issues/">let me know</a> if you need it!</p>
<ul>
<li>centering a single mark above the letter,</li>
<li>support for at least three stacked marks (including the non-faked one),</li>
<li>support for marks below the letter,</li>
<li>stacking things which don't have Unicode general category <em>Mn</em>,</li>
<li>a command/argument to set the desired height of boxes generated with the <code>\stackMarks</code>* commands,</li>
<li>make it possible to set <code>\stackMarksMarkBase</code> individually for B/I/BI faces.</li>
</ul>
<p>(The above is roughly an order of importance, at least as far as I'm concerned.)</p>
<h2 id="dependencies">Dependencies</h2>
<ul>
<li><a href="http://mirrors.ctan.org/macros/latex/contrib/l3packages/xparse.pdf">The <code>xparse</code> package</a></li>
<li><a href="http://mirrors.ctan.org/macros/latex/required/tools/calc.pdf">The <code>calc</code> package</a></li>
</ul>
<h2 id="installation">Installation</h2>
<p>I regard this as a hack, so it never will be a real, properly packaged package on CTAN. Instead do this (on Linux, or its equivalent on your system):</p>
<pre><code>cd ~
mkdir -p texmf/tex/latex
cd -p texmf/tex/latex
git clone https://github.com/bpj/stackmarks-xelatex.git</code></pre>
<p>this should create a directory <code>~/texmf/tex/latex/stackmarks-xelatex</code> which contains the necessary files and documentation.</p>
<p>to update do:</p>
<pre><code>cd ~/texmf/tex/latex/stackmarks-xelatex
git pull</code></pre>
<h2 id="basic-usage">Basic usage</h2>
<pre><code>...
\usepackage{stackmarks}
\setmainfont{FreeSerif}

\renewcommand{\stackMarksMarkBase}{r}
\renewcommand{\stackMarksRaiseFixEx}{-0.01}
\renewcommand{\stackMarksBRaiseFixEx}{-0.01}
\renewcommand{\stackMarksIRaiseFixEx}{-0.01}
\renewcommand{\stackMarksBIRaiseFixEx}{-0.01}
\renewcommand{\stackMarksKernFixEm}{0.0}
\renewcommand{\stackMarksIKernFixEm}{0.15}
\renewcommand{\stackMarksBKernFixEm}{0.09}
\renewcommand{\stackMarksBIKernFixEm}{0.0}

...

\begin{document}

χώρα is transliterated \textit{ch\stackMarks{ō}{\char&quot;0301}ra}

\end{document}</code></pre>
<h2 id="user-macros-for-stacking-diacritics">User macros for stacking diacritics</h2>
<p>All of these use <a href="http://mirrors.ctan.org/macros/latex/contrib/l3packages/xparse.pdf">xparse</a> to handle their arguments, and yes all arguments in <code>{...}</code> are required, and all those in <code>[...]</code> are optional. Those in <code>&lt;...&gt;</code> should actually be entered as <code>&lt;r&gt;</code> etc., with angle brackets (well, less/greater signs) <em>instead</em> of curly or angle brackets. They are optional too and mean that you should enter characters the measures of which will be used to determine the placement of marks relative their base.</p>
<h3 id="stackmarks"><code>\stackMarks</code></h3>
<h3 id="stackmarksb"><code>\stackMarksB</code></h3>
<h3 id="stackmarksi"><code>\stackMarksI</code></h3>
<h3 id="stackmarksbi"><code>\stackMarksBI</code></h3>
<p>A basic call, relying on defaults takes only two arguments, viz. the base letter with the lower mark, and the upper mark to be placed above it:</p>
<pre><code>\stackMarks{BASE}{MARK}</code></pre>
<p>as in</p>
<pre><code>\stackMarks{Ā}{\char&quot;0301}</code></pre>
<p>Normally the upper mark is placed in a zero-width, zero-height box which is raised a length equal to the difference in height between the box containing the <em>base</em>, and an empty box with the same proportions as the box containing the <code>\stackMarksMarkBase</code> -- a letter fitting the actual kerning and height of the overstriking combining mark glyphs in the font, and kerned so that the center of the <em>mark</em> glyph stands over the center of the <em>base</em> box.</p>
<p>(The <code>\stackMarks</code>* commands always use relative units -- <em>em</em> and <em>ex</em> -- in the hope that the calculated mark placement will work equally well at different sizes.)</p>
<p>Because the box containing the upper mark does not have any width or height the spacing between lines will not be affected. This is intended as a feature -- you may need to increase the spacing between lines to accomodate stacked marks, but this is better done globally so that the entire document uses the same spacing. If this is not desired, e.g. because you use only a few stacked marks, you can use s something like</p>
<pre><code>\raisebox{0p}[1.5em]{\stackmarks{Ā}{\char&quot;0301}}</code></pre>
<p>Depending on the font this necessarily simple placement algorithm does not always lead to results which look good. For this reason there are a number of optional extra parameters which can be used to fine-tune the placement of the upper mark; you can, so to say, 'lie' to the commands about the width and the height of the <em>base</em>s bounding box, as well as specifying a custom letter to calculate the proportions of the <code>\stackMarksMarkBase</code> box. Each of these optional extra commands has a default, which is equal to the return value of a command which shall be redefined by the user to reflect the actual needs of the <em>mainfont</em> of the document. These default- defining commands are described further below. Because the needed default values will usually differ between normal, bold, italic and bold italic faces of a font there is a variant form of <code>\stackMarks</code>, with different defaults, for each of Bold, Italic and BoldItalic, called <code>\stackMarksB</code>, <code>\stackMarksI</code>, and <code>\stackMarksBI</code> respectively, which each should be used in the appropriate context.</p>
<p>The full set of arguments is between two and five:</p>
<pre><code>\stackMarks[KERN FIX]{BASE}[RAISE FIX]{MARK}[FAKE BASE]</code></pre>
<p>The six possible arguments are, in order:</p>
<dl>
<dt>[<em>kern fix</em>]</dt>
<dd><p>A (decimal) number specifying, as a fraction of an <em>em</em> like <code>0.15</code> or <code>-0.09</code>, how much extra kerning to add or, more often, subtract, to the kern centering the upper <em>mark</em> over the <em>base</em>.</p>
<p>When calculating the kern the length <code>1em</code> will be multiplied by this value and added to a length which is equal to half the width of the <em>base</em> bounding box.</p>
<p>This argument defaults to the value -- which should be a decimal number -- returned by the commands <code>\stackMarksKernFixEm</code>, <code>\stackMarksBKernFixEm</code> and so on, which you shouuld redefine to values appropriate for your main font, and for which see below.</p>
</dd>
<dt>{<em>base</em>}</dt>
<dd><p>This mandatory argument should be the letter with the lower diacritical mark, upon which the stacked mark should be placed. In fact it can be any string, so it can be used with varying success to center a diacritical mark above a wide or narrow letter like <code>m</code> or <code>l</code> in cases where the font doesn't do this right by itself, or to place a (single) diacritic above two tied letters like <code>a͡u</code>. Remember that in such cases you may need to explicitly use <code>ı</code> U+0131 LATIN SMALL LETTER DOTLESS I and <code>ȷ</code> U+0237 LATIN SMALL LETTER DOTLESS J.</p>
</dd>
<dt>[<em>raise fix</em>]</dt>
<dd><p>A (decimal) number specifying, as a fraction of an <em>ex</em> like <code>0.005</code> or <code>-0.01</code>, how much extra 'raise' (as in <code>\raisebox</code>) to add or, more often, subtract, to the kern centering the upper <em>mark</em> over the <em>base</em>.</p>
<p>When calculating the 'raise' the length <code>1ex</code> will be multiplied by this value and added to a length which is equal to the difference in height between the <em>base</em> and the <em>mark base</em> (see below!).</p>
<p>This argument defaults to the value -- which should be a decimal number -- returned by the commands <code>\stackMarksRaiseFixEx</code>, <code>\stackMarksRaiseFixEx</code> and so on, which you should redefine to values appropriate for your main font, and for which see below.</p>
<p>This is the vertical counterpart of <em>kern fix</em>, which see.</p>
<p><strong>Note</strong> that while the <em>kern fix</em> is given in terms of an <em>em</em> the <em>raise fix</em> is given in terms of an <em>ex</em>! This is so as to not get decimal values with a lot of leading zeros, and so that you can estimate the needed value by visually comparing the height of a <em>base</em> letter with the 'raise' of the <em>mark</em>.</p>
</dd>
<dt>{<em>mark</em>}</dt>
<dd><p>This second mandatory argument is the (upper) <em>mark</em> to place above the <em>base</em>. While you can give this mark in any notation LaTeX understands, including an actual combining mark character it is often practical to use the \char&quot;<em>xxxx</em> notation like <code>\char&quot;0301</code>for COMBINING ACUTE ACCENT or an ad hoc defined command like <code>\newcommand{\acuteAccentMark}{\char&quot;0301}</code>.</p>
</dd>
<dt>[<em>fake base</em>]</dt>
<dd><p>in some fonts a combining diacritical mark in the <em>base</em> will not contribute to the bounding box of the <em>base</em>. In these cases you may give as this extra optional argument a comparable precomposed letter+diacritic character, and the height of the bounding box of that letter will be used to compute the 'raise' of the upper <em>mark</em> instead of the height of the actual <em>base</em>.</p>
</dd>
</dl>
<h2 id="adjusting-the-raise-and-kerning-of-marks">Adjusting the 'raise' and kerning of marks</h2>
<p>These macros should be redefined to set the defaults of the optional arguments (except for the <em>fake base</em> for which it makes no sense to have a default) to appropriate values for the <em>mainfont</em> of your document, or rather the main font which you need to fix with this package!</p>
<p>These are defined with the standard LaTeX <code>\newcommand</code> and thus should be redefined with <code>\renewcommand</code>, and <em>not</em> the corresponding <a href="http://mirrors.ctan.org/macros/latex/contrib/l3packages/xparse.pdf">xparse</a> commands!.</p>
<h3 id="stackmarksmarkbase"><code>\stackMarksMarkBase</code></h3>
<p>Should return a letter/glyph which in the absence of anchors has the right proportions for an overstriking (combining) diacritical mark. Its proportions will be used to determine the placement of the stacked mark relative to the actual <em>base</em>. In most Latin- script fonts this letter will be a medium-width lowercase letter; in practice I've found this to often be <code>r</code>, which is usually a bit narrower than <code>a</code> or <code>n</code> and a bit wider than <code>i</code> and <code>l</code>, and consequently <code>r</code> is the default value. I'm still to encounter a case where the needed <code>\stackMarksMarkBase</code> is different for the different faces of a font, so there is currently only one command used for all. I'm also still to encounter a case where the needed value is not the same for all marks, for which reason this is not a parameter.</p>
<h3 id="redefinable-macros-for-setting-default-arguments">Redefinable macros for setting default arguments</h3>
<p>Cf. the <em>kern fix</em> and <em>raise fix</em> arguments to <code>\stackMarks</code> above!</p>
<p>As mentioned above there are two extra arguments to <code>\stackMarks</code> and friends, referred to above as <em>kern fix</em> and <em>raise fix</em> which may be used to fine-tune the placement of the <em>mark</em> above the <em>base</em>.</p>
<p>This may, depending on the font, be especially necessary with italics, where the geometrical center of the bounding box of the base often does not coincide with the visual center of the lower diacritical mark, included in the base.</p>
<p>Because the needed default values will usually differ between normal, bold, italic and bold italic faces of a font there is a variant form of <code>\stackMarks</code>, with different defaults, for each of Bold, Italic and BoldItalic, called <code>\stackMarksB</code>, <code>\stackMarksI</code>, and <code>\stackMarksBI</code> respectively, which each should be used in the appropriate context, and their defaults can be changed individually by redefining the following commands:</p>
<ul>
<li><code>\stackMarksKernFixEm</code>,</li>
<li><code>\stackMarksIKernFixEm</code>,</li>
<li><code>\stackMarksBKernFixEm</code>,</li>
<li><code>\stackMarksBIKernFixEm</code>,</li>
</ul>
<p>for the <em>kern fix</em> of each face, and</p>
<ul>
<li><code>\stackMarksRaiseFixEx</code>,</li>
<li><code>\stackMarksBRaiseFixEx</code>,</li>
<li><code>\stackMarksIRaiseFixEx</code>,</li>
<li><code>\stackMarksBIRaiseFixEx</code>,</li>
</ul>
<p>for the <em>raise fix</em> of each face.</p>
<p>Note that the values returned by these commands should <strong>not</strong> be LaTeX <code>length</code>s but <em>decimal numbers</em>, usually smaller than 1 since they are given in terms of <em>em</em> and <em>ex</em> respectively! (The <code>\stackMarks</code>* commands always use relative units -- <em>em</em> and <em>ex</em> -- in the hope that the calculated mark placement will work equally well at different sizes.)</p>
<p>When loading the package the value returned by each of these commands is <code>0.0</code> which may or may not be appropriate for your font.</p>
<p>You should write a test document where you place different upper marks over several letters (at least <code>a, b, i, l, m, n, r, t</code> and their respective capitals) of different height and width and with different lower diacritical marks, in the four styles, and zooming the produced PDF page to simulate differences in size, to determine the most suitable default values, then redefine the <code>\stackMarksKernFixEm</code>, <code>\stackMarksRaiseFixEx</code> and related commands to these values in your main document. There is no substitute to trial and error and trusting your eyes. Once you have found your ideal values for a particular font family you can save those values in a <em>.sty</em> file (or a <em>.tex</em> file which you <code>\include</code>) for later reuse. Remember that if you can't find a single value which looks good on all of the above- mentioned letters you should set a default which looks good on most of them and define wrapper commands with suitable values as arguments for the rest.</p>
<p>Such a file for setting custom defaults may look something like this:</p>
<pre><code>% stackmarksfreeserif.sty
% custom defaults for stackmarks appropriate for FreeSerif

\ProvidesPackage{stackmarksfreeserif}
\NeedsTeXFormat{LaTeX2e}
\usepackage{stackmarks}

\renewcommand{\stackMarksMarkBase}{r}
\renewcommand{\stackMarksRaiseFixEx}{-0.01}
\renewcommand{\stackMarksBRaiseFixEx}{-0.01}
\renewcommand{\stackMarksIRaiseFixEx}{-0.01}
\renewcommand{\stackMarksBIRaiseFixEx}{-0.01}
\renewcommand{\stackMarksKernFixEm}{0.0}
\renewcommand{\stackMarksIKernFixEm}{0.15}
\renewcommand{\stackMarksBKernFixEm}{0.09}
\renewcommand{\stackMarksBIKernFixEm}{0.0}</code></pre>
<h1 id="section"><!-- linkage --></h1>
<!-- vim: set tw=0: -->


