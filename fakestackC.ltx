\usepackage{xparse}
\usepackage{calc}
\usepackage{ifthen}

\newlength{\loMarkRaiseAdjust}
\newlength{\hiMarkRaiseAdjust}
\newlength{\markItalic}
\setlength{\loMarkRaiseAdjust}{1ex*-1/100}
\setlength{\hiMarkRaiseAdjust}{1ex*-1/100}
\newlength{\loMarkRaise}
\newlength{\hiMarkRaise}
\newlength{\markBaseHt}
\newlength{\markKern}
\newsavebox{\markBox}
\NewDocumentCommand\makeMarkBox{%
    m   %   #1  base
    m   %   #2  mark
    m   %   #3  markbase
    m   %   #4  raise
}{%
    \leavevmode%
    \protect\makebox[0em][c]{%
        \protect\makebox[\widthof{#1}][c]{%
            \protect\raisebox{#4}{%
                \protect\makebox[\widthof{#3}][r]{#2}%
            }%
        }%
    }%
}%
\NewDocumentCommand\stackMark{%
    o               %   #1  use italic adjustment
    D**{0.1}       %   #2  amount of bold adjustment, in ems
    D//{0.15}       %   #3  amount of italic adjustment, in ems
    D<>{r}          %   #4  box for marks is as wide/high as this
    m               %   #5  base/letter
    O{-0.01}        %   #6  mark raise adjustment, in exes
    d<>             %   #7  use height of this as base letter height
    m               %   #8  higher mark
}{%
    \leavevmode%
    \setlength{\hiMarkRaise}{1ex*\real{#6}}%
    \addtolength{\hiMarkRaise}{\heightof{#5}-\heightof{#4}}%
    \setlength{\markKern}{\widthof{#5}/2}%
    \IfNoValueF{#1}{%
        \ifthenelse{\equal{#1}{bi}}{%
            \addtolength{\markKern}{1em*\real{#3}-1em*\real{#2}}%
        }{%
            \ifthenelse{\equal{#1}{b}}{%
                \addtolength{\markKern}{1em*\real{#2}}%
            }{%
                \addtolength{\markKern}{1em*\real{#3}}%
            }%
        }%
    }%
    #5%
    \kern-\markKern%
    \makeMarkBox{#5}{#8}{#4}{\hiMarkRaise}%
    \kern\markKern%
}%
